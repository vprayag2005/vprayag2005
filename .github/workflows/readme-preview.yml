name: README Preview

on:
  pull_request:
    paths:
      - 'README.md'
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull request number to post preview comment'
        required: true
        type: number

jobs:
  preview:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    
    steps:
      - name: Get PR details for workflow_dispatch
        if: github.event_name == 'workflow_dispatch'
        id: pr_details
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = parseInt(context.payload.inputs.pr_number);
            if (!prNumber || isNaN(prNumber)) {
              core.setFailed('Invalid PR number provided');
              return;
            }
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            core.setOutput('head_sha', pr.head.sha);
            console.log(`Fetched PR #${prNumber} with head SHA: ${pr.head.sha}`);
      
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || steps.pr_details.outputs.head_sha || github.sha }}
      
      - name: Post preview comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            // Determine the PR number based on the event type
            const prNumber = context.eventName === 'pull_request' 
              ? context.issue.number 
              : parseInt(context.payload.inputs.pr_number);
            
            // Validate PR number
            if (!prNumber || isNaN(prNumber)) {
              core.setFailed('Invalid or missing PR number');
              return;
            }
            
            // Read README content safely from file with error handling
            let readmeContent;
            try {
              readmeContent = fs.readFileSync('README.md', 'utf8');
            } catch (error) {
              console.error('Error reading README.md:', error.message);
              core.setFailed('Failed to read README.md file');
              return;
            }
            
            // Create the comment body with preview - using array join to avoid template literal injection
            const commentParts = [
              '## üìù README Preview',
              '',
              'This is a preview of how the README will look after this PR is merged:',
              '',
              '---',
              '',
              readmeContent,
              '',
              '---',
              '',
              '*This preview was automatically generated by the README Preview workflow.*'
            ];
            const commentBody = commentParts.join('\n');
            
            // Find existing preview comment from this specific bot
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            
            const botComment = comments.find(comment => 
              comment.user.login === 'github-actions[bot]' && 
              comment.body.includes('üìù README Preview')
            );
            
            // Update or create comment
            try {
              if (botComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: commentBody
                });
                console.log('Updated existing preview comment');
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: commentBody
                });
                console.log('Created new preview comment');
              }
            } catch (error) {
              console.error('Error posting comment:', error.message);
              core.setFailed('Failed to post preview comment');
            }
